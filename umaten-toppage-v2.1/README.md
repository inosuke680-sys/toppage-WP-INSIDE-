# Umaten トップページプラグイン v2.1.0

WordPressのトップページ用プラグインです。動的なカテゴリ・タグ表示機能を備え、全エリア対応の3ステップナビゲーションで内部リンク最適化を実現しています。

**バージョン**: 2.1.0

## 🎉 v2.1.0の重要な改善点

### 1. URLリライトロジックの完全再設計 ⭐⭐⭐
- **根本的な解決**: 投稿URLが正常に表示されない問題を完全に修正
- **新アプローチ**: リライトルールを使わず、404ベースの処理に変更
- **改善内容**:
  - `add_rewrite_rule()`を完全に廃止
  - 404エラー時のみカスタム処理を実行
  - WordPressのデフォルト投稿処理を完全に優先
  - 投稿、ページ、カスタム投稿タイプを一切妨げない
- **修正された問題**:
  - ✅ `/hokkaido/curry-ya-jack-hakodate-nakajima/` のような投稿URLが完璧に表示される
  - ✅ 記事が公開状態でも下書き状態でも正常に動作
  - ✅ カテゴリアーカイブページも正常に機能

### 2. 処理フローの最適化
```
従来（v2.0.0）：
リライトルール → parse_request → 投稿検出 → template_redirect
↓
問題：投稿URLをリライトルールが先に捕捉してしまう

新方式（v2.1.0）：
WordPressのデフォルト処理 → 404? → カスタム処理
↓
解決：投稿URLはWordPressが先に処理、404時のみカスタム介入
```

### 3. シンプルで堅牢なコード
- コード行数を大幅削減（約40%削減）
- 複雑な投稿検出ロジックを削除
- メンテナンス性の大幅向上

## v2.0.0からの主な違い

| 項目 | v2.0.0 | v2.1.0 |
|-----|--------|--------|
| リライトルール | 使用（priority: bottom） | **不使用** |
| 処理タイミング | parse_request + template_redirect | **404時のみ** |
| 投稿検出 | 複雑なDB検索 + カテゴリチェック | **不要** |
| WordPressとの統合 | 部分的 | **完全** |
| コード複雑度 | 高 | **低** |

## 動作原理

```php
// v2.1.0の動作フロー
1. ユーザーがURLにアクセス
   ↓
2. WordPressがデフォルト処理
   - 投稿やページが存在 → 通常表示
   - 存在しない → 404エラー
   ↓
3. 404エラーの場合のみ当プラグインが介入
   - URLをパース (/親/子/タグ/)
   - カテゴリ/タグの存在を確認
   - 存在すれば → アーカイブページとして表示
   - 存在しなければ → 通常の404ページ
```

## 主な機能

- ✅ 全エリア対応の3ステップナビゲーション（親→子カテゴリ→ジャンル/タグ）
- ✅ URLリライト（404ベース処理で投稿と完全に分離）
- ✅ SEO最適化（canonical URL、OGP、Twitter Card）
- ✅ アイキャッチ画像自動設定
- ✅ 検索結果ページ（モダンUI）
- ✅ 独自アクセスカウント機能
- ✅ カテゴリ・タグによる高度な絞り込み
- ✅ ページネーション対応
- ✅ モバイルファースト設計

## インストール

1. プラグインフォルダをWordPressの`wp-content/plugins/`にアップロード
2. WordPress管理画面でプラグインを有効化
3. **重要**: 「設定」→「パーマリンク設定」→「変更を保存」をクリック

## 使用方法

### URL構造

- **投稿ページ**: `/hokkaido/curry-ya-jack-hakodate-nakajima/`
  → 正常に投稿として表示 ✅

- **カテゴリページ**: `/hokkaido/hakodate/`
  → 函館のすべての投稿を表示

- **タグ絞り込み**: `/hokkaido/hakodate/ramen/`
  → 函館のラーメン投稿を表示

## v2.1.0で修正された問題

### 問題1: 投稿ページが検索結果として表示される

**症状**:
```html
<main id="main_content" class="l-mainContent l-article">
  <div class="p-homeContent l-parent u-mt-40">
    <div class="c-tabBody p-postListTabBody">
      <ul class="p-postList -type-card -pc-col3 -sp-col1">
        <li class="p-postList__item">
          <!-- 記事の内容ではなくカードが表示される -->
        </li>
      </ul>
    </div>
  </div>
</main>
```

**原因**:
- v2.0.0のリライトルールが投稿URLを先に捕捉
- `/hokkaido/curry-ya-jack-hakodate-nakajima/` が `/親/子/` パターンとして処理
- 投稿検出ロジックが失敗し、アーカイブページとして表示

**v2.1.0での解決**:
- リライトルールを完全廃止
- WordPressのデフォルト処理に完全に任せる
- 404時のみカスタム処理を実行

### 問題2: 記事が公開状態になると正常に動作しない

**v2.1.0での解決**:
- 投稿ステータス（publish、draft、pending）に関わらず正常動作
- WordPressのデフォルト処理を妨げないため

## トラブルシューティング

### デプロイ後の必須手順

デプロイ後、**必ず以下を実行してください：**

1. WordPress管理画面にログイン
2. 「設定」→「パーマリンク設定」
3. 何も変更せず「変更を保存」をクリック

これでリライトルールがリセットされ、v2.1.0の処理が有効になります。

### 投稿ページが表示されない場合

1. パーマリンク設定をフラッシュ（上記参照）
2. ブラウザのキャッシュをクリア
3. サーバーのPHP-FPMを再起動: `sudo systemctl restart php-fpm`

### カテゴリページが表示されない場合

1. カテゴリスラッグが正しく設定されているか確認
2. カテゴリに投稿が存在するか確認
3. パーマリンク設定をフラッシュ

## 技術仕様

### v2.1.0の技術的特徴

- **処理フック**: `template_redirect` (priority: 999)
- **判定条件**: `is_404()` のみ
- **カスタムクエリ**: `WP_Query` で動的に生成
- **テンプレート**: `archive.php` または `index.php`

### 必須環境

- WordPress: 5.0以上
- PHP: 7.4以上
- MySQL: 5.7以上

## バージョン履歴

### 2.1.0 (2025-11-15)
- **重要**: URLリライトロジックの完全再設計
  - リライトルールを完全廃止し、404ベース処理に変更
  - WordPressのデフォルト処理を完全に優先
  - 投稿URLが正常に表示される問題を根本的に解決
- **改善**: コードの大幅簡素化（約40%削減）
- **修正**: 記事が公開状態になると正常に動作しない問題を完全解決
- **修正**: 投稿ページがアーカイブページとして表示される問題を完全解決

### 2.0.0 (2025-11-15)
- URLリライトロジックの根本的改善（parse_request導入）
- 検索結果ページのモダンUI実装
- パフォーマンス最適化

### 1.6.0 (2025-11-14)
- 投稿ページの正常表示対応（初回試み）
- SEOメタタグ強化

## サポート

問題が発生した場合は、以下の情報を添えてお問い合わせください：
- WordPressのバージョン
- PHPのバージョン
- 使用しているテーマ
- エラーの詳細（ページのHTMLソース含む）

## ライセンス

GPL v2 or later

## 作者

Umaten (https://umaten.jp)

---

**v2.1.0** - 投稿とカテゴリの完全な区別を実現
