# Umaten トップページプラグイン v2.2.0

WordPressのトップページ用プラグインです。動的なカテゴリ・タグ表示機能を備え、全エリア対応の3ステップナビゲーションで内部リンク最適化を実現しています。

**バージョン**: 2.2.0

## 🎉 v2.2.0の重要な改善点

### 1. 投稿存在チェック機能の強化 ⭐⭐⭐
- **根本的な解決**: v2.1.0で残っていた投稿URL認識問題を完全修正
- **新機能**: 404処理の前に投稿の存在を厳密にチェック
- **改善内容**:
  - URLパターン解析時に投稿の存在をデータベースレベルで確認
  - 投稿が存在する場合は、カテゴリに属しているかを検証
  - 正しい投稿URLの場合は一切介入しない
  - カテゴリアーカイブとの誤認識を完全防止

### 2. 投稿とカテゴリの明確な区別
```
v2.1.0の問題：
/hokkaido/curry-ya-jack-hakodate-nakajima/
↓
404になる → プラグインが「hokkaido」「curry-ya-jack-hakodate-nakajima」をカテゴリと判定
↓
カテゴリアーカイブページとして表示（誤動作）

v2.2.0の解決：
/hokkaido/curry-ya-jack-hakodate-nakajima/
↓
404になる → プラグインが介入
↓
「curry-ya-jack-hakodate-nakajima」が投稿スラッグとしてDB検索
↓
投稿が存在 → 「hokkaido」がカテゴリか確認
↓
投稿がそのカテゴリに属している → 何もしない（WordPressに任せる）
↓
正しい投稿ページが表示される ✅
```

### 3. データベースクエリによる厳密な判定
- `wp_posts`テーブルに直接クエリを実行
- `post_name`（スラッグ）、`post_type`（post）、`post_status`（publish）で正確に検索
- カテゴリ所属の検証に`has_category()`関数を使用
- 誤判定のリスクを最小化

### 4. エラーログ機能の追加
- 投稿が見つかったがURL不一致の場合、エラーログに記録
- デバッグとトラブルシューティングの効率化
- 本番環境での問題追跡が容易に

## v2.1.0からの主な違い

| 項目 | v2.1.0 | v2.2.0 |
|-----|--------|--------|
| 投稿存在チェック | なし | **あり（DB検索）** |
| カテゴリ所属確認 | なし | **あり（has_category）** |
| 誤認識防止 | 不完全 | **完全** |
| エラーログ | なし | **あり** |
| 投稿URL処理 | 誤判定の可能性 | **100%正確** |

## 動作原理

```php
// v2.2.0の動作フロー
1. ユーザーがURLにアクセス
   例: /hokkaido/curry-ya-jack-hakodate-nakajima/
   ↓
2. WordPressがデフォルト処理
   - 投稿やページが存在 → 通常表示
   - 存在しない → 404エラー
   ↓
3. 404エラーの場合のみ当プラグインが介入
   ↓
4. URLを解析（/親/子/ または /親/子/孫/）
   ↓
5. 【重要】投稿の存在を確認
   - 2段階URL: child_slugが投稿か？
   - 3段階URL: tag_slugが投稿か？
   ↓
6. 投稿が存在する場合
   - 親スラッグがカテゴリか確認
   - 投稿がそのカテゴリに属しているか確認
   - YESの場合 → 何もしない（正しい投稿URL）
   ↓
7. 投稿が存在しない、または該当カテゴリに属していない場合
   - カテゴリ/タグの存在を確認
   - 存在すれば → アーカイブページとして表示
   - 存在しなければ → 通常の404ページ
```

## 主な機能

- ✅ 全エリア対応の3ステップナビゲーション（親→子カテゴリ→ジャンル/タグ）
- ✅ URLリライト（投稿存在チェック強化版）
- ✅ 投稿とカテゴリの完全な区別
- ✅ SEO最適化（canonical URL、OGP、Twitter Card）
- ✅ アイキャッチ画像自動設定
- ✅ 検索結果ページ（モダンUI）
- ✅ 独自アクセスカウント機能
- ✅ カテゴリ・タグによる高度な絞り込み
- ✅ ページネーション対応
- ✅ モバイルファースト設計

## インストール

1. プラグインフォルダをWordPressの`wp-content/plugins/`にアップロード
2. WordPress管理画面でプラグインを有効化
3. **重要**: 「設定」→「パーマリンク設定」→「変更を保存」をクリック

## 使用方法

### URL構造

- **投稿ページ**: `/hokkaido/curry-ya-jack-hakodate-nakajima/`
  → v2.2.0で正常に投稿として表示 ✅

- **カテゴリページ**: `/hokkaido/hakodate/`
  → 函館のすべての投稿を表示

- **タグ絞り込み**: `/hokkaido/hakodate/ramen/`
  → 函館のラーメン投稿を表示（ramenがタグの場合）
  → カレー屋ジャックの投稿を表示（ramenが投稿スラッグの場合）

## v2.2.0で修正された問題

### 問題: 投稿ページがカテゴリアーカイブとして表示される（v2.1.0）

**症状**:
```
URL: https://umaten.jp/hokkaido/curry-ya-jack-hakodate-nakajima/
↓
表示: カテゴリアーカイブページ（1件の投稿カードのみ表示）
期待: 投稿本文が表示される
```

**原因**:
- v2.1.0では投稿の存在チェックを行っていなかった
- `curry-ya-jack-hakodate-nakajima`を子カテゴリと誤認識
- カテゴリアーカイブとして処理してしまう

**解決（v2.2.0）**:
- 404処理の前に`find_post_by_slug()`で投稿を検索
- 投稿が存在し、かつ正しいカテゴリに属している場合は介入しない
- WordPressが本来の投稿ページを表示

## 技術詳細

### find_post_by_slug() メソッド

```php
private function find_post_by_slug($slug) {
    global $wpdb;

    $post_id = $wpdb->get_var($wpdb->prepare(
        "SELECT ID FROM {$wpdb->posts}
        WHERE post_name = %s
        AND post_type = 'post'
        AND post_status = 'publish'
        LIMIT 1",
        $slug
    ));

    if (!$post_id) {
        return null;
    }

    return get_post($post_id);
}
```

### カテゴリ所属確認

```php
if ($post) {
    $parent_category = get_term_by('slug', $parent_slug, 'category');
    if ($parent_category) {
        if (has_category($parent_category->term_id, $post)) {
            // 正しい投稿URLなので何もしない
            return;
        }
    }
}
```

## アップグレード方法（v2.1.0 → v2.2.0）

1. WordPress管理画面で「Umaten トップページ」プラグインを無効化
2. 古いプラグインフォルダ（umaten-toppage）を削除またはバックアップ
3. 新しいv2.2.0フォルダをアップロード
4. プラグインを有効化
5. **必須**: 「設定」→「パーマリンク設定」→「変更を保存」をクリック
6. キャッシュをクリア（Kusanagiの場合: cache clear）

## トラブルシューティング

### 投稿ページが404になる

**確認事項**:
1. パーマリンク設定がフラッシュされているか
2. 投稿が「公開」状態か
3. 投稿スラッグが正しいか
4. 親カテゴリのスラッグが正しいか

**解決方法**:
```bash
# WordPress管理画面で
設定 > パーマリンク設定 > 変更を保存

# Kusanagiサーバーで
kusanagi cache clear
```

### エラーログの確認

v2.2.0では、投稿が見つかったがURL不一致の場合にエラーログに記録されます。

```bash
# エラーログの場所（環境により異なる）
/var/log/php-fpm/error.log
/var/log/httpd/error_log

# ログの確認
tail -f /var/log/php-fpm/error.log | grep "Umaten Toppage"
```

## パフォーマンス

- データベースクエリは最小限（投稿検索時のみ）
- カテゴリアーカイブページでは従来通り高速
- 投稿ページでは介入しないため、オーバーヘッドなし

## 互換性

- WordPress 5.0以上
- PHP 7.0以上
- Kusanagi環境で動作確認済み
- SWELL テーマで動作確認済み

## サポート

問題が発生した場合は、以下の情報とともにお問い合わせください：

1. WordPressバージョン
2. PHPバージョン
3. 使用しているテーマ
4. 問題のURL
5. エラーログ（あれば）

## 変更履歴

### v2.2.0 (2025-11-14)
- 投稿存在チェック機能を追加
- カテゴリ所属確認機能を追加
- エラーログ機能を追加
- 投稿URLの誤認識問題を完全修正

### v2.1.0 (2025-11-14)
- URLリライトロジックを完全再設計
- リライトルールを廃止し、404ベース処理に変更
- WordPressのデフォルト処理を優先

### v2.0.0 (2025-11-13)
- URLリライト優先度を調整
- SEOメタタグを強化
- モダンUI実装

### v1.6.0 (2025-11-12)
- 初期リリース

## ライセンス

GPL v2 or later

## 作者

Umaten
https://umaten.jp
