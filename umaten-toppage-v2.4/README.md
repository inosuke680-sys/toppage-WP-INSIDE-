# Umaten トップページプラグイン v2.4.0

WordPressのトップページ用プラグインです。動的なカテゴリ・タグ表示機能を備え、全エリア対応の3ステップナビゲーションで内部リンク最適化を実現しています。

**バージョン**: 2.4.0

## 🚨 v2.4.0の緊急修正

### 1. 管理画面セーフ実装 ⭐⭐⭐
- **緊急修正**: v2.3.0で発生した「Could not update post in the database」エラーを修正
- **原因**: v2.3.0のコードが管理画面でも実行され、投稿の更新処理に干渉
- **解決策**:
  - `is_admin()`チェックを追加
  - 管理画面では一切処理しない
  - フロントエンドでのみ動作

### 2. グローバル変数の安全な扱い
- **改善**: `global $post`の上書きを安全な方法に変更
- **v2.3.0の問題**:
  ```php
  global $post;
  $post = get_post($args['p']);
  setup_postdata($post);
  ```
  → これが管理画面の投稿更新を妨げていた

- **v2.4.0の解決**:
  ```php
  if ($wp_query->have_posts()) {
      $wp_query->the_post();  // WordPressの標準的な方法
  }
  ```
  → `the_post()`を使用して、WordPressの標準的な方法で設定

### 3. メインクエリの同期
- `$wp_the_query`も同期させることで、より確実な動作を実現
- WordPressのクエリシステムとの完全な互換性を確保

### 4. デバッグログの追加
- `WP_DEBUG`が有効な場合、動作ログを出力
- トラブルシューティングの効率化

## v2.3.0の問題と解決

### 問題: 投稿の更新・編集ができない

**症状**:
```
WordPress管理画面で投稿を下書きに戻そうとすると：
「更新に失敗しました。Could not update post in the database.」エラー
```

**原因**:
```php
// v2.3.0の問題コード
public function handle_404_redirect() {
    // 管理画面チェックがない！
    // ↓
    global $post;
    $post = get_post($args['p']);  // グローバル$postを上書き
    setup_postdata($post);         // 投稿データを設定
    // ↓
    // これが管理画面の投稿保存処理を妨げる
}
```

**解決（v2.4.0）**:
```php
// v2.4.0の解決コード
public function handle_404_redirect() {
    // 【v2.4.0 重要】管理画面では一切処理しない
    if (is_admin()) {
        return;
    }

    // ... 以降の処理はフロントエンドのみ

    // 【v2.4.0 改善】グローバル$postの設定を安全に行う
    if ($wp_query->have_posts()) {
        $wp_query->the_post();  // WordPressの標準的な方法
    }
}
```

## v2.3.0からの主な違い

| 項目 | v2.3.0 | v2.4.0 |
|------|--------|--------|
| 管理画面チェック | ❌ なし | ✅ is_admin() |
| グローバル$post設定 | ❌ 直接上書き | ✅ the_post() |
| $wp_the_query同期 | ❌ なし | ✅ あり |
| デバッグログ | ❌ なし | ✅ あり |
| 投稿更新 | ❌ エラー | ✅ 正常 |
| フロントエンド表示 | ✅ 正常 | ✅ 正常 |

## 主な機能

- ✅ 全エリア対応の3ステップナビゲーション（親→子カテゴリ→ジャンル/タグ）
- ✅ URLリライト（管理画面セーフ実装）
- ✅ 投稿とカテゴリの完全な区別
- ✅ 投稿ページの正常表示
- ✅ 管理画面での投稿編集・更新が正常に動作
- ✅ SEO最適化（canonical URL、OGP、Twitter Card）
- ✅ アイキャッチ画像自動設定
- ✅ 検索結果ページ（モダンUI）
- ✅ 独自アクセスカウント機能
- ✅ カテゴリ・タグによる高度な絞り込み
- ✅ ページネーション対応
- ✅ モバイルファースト設計

## 緊急インストール（v2.3.0からのアップグレード）

### 【重要】v2.3.0をご使用の方は、至急v2.4.0にアップグレードしてください

v2.3.0には投稿の編集・更新ができなくなる重大な不具合があります。

### アップグレード手順

1. **プラグインを無効化**（削除はしない）
   ```
   WordPress管理画面 > プラグイン > Umaten トップページ > 無効化
   ```

2. **v2.4.0ファイルをアップロード**
   - 古いファイルを上書き、またはフォルダを置き換え

3. **プラグインを有効化**
   ```
   WordPress管理画面 > プラグイン > Umaten トップページ > 有効化
   ```

4. **パーマリンク設定をフラッシュ**
   ```
   WordPress管理画面 > 設定 > パーマリンク設定 > 変更を保存
   ```

5. **キャッシュをクリア**
   - 管理バーの「cache clear」をクリック

6. **動作確認**
   - 投稿の編集ができるか確認
   - 公開投稿が正しく表示されるか確認

## トラブルシューティング

### v2.3.0で投稿が更新できなくなった場合

1. **至急v2.4.0にアップグレード**
   - 上記の「緊急インストール」手順に従ってください

2. **それでも更新できない場合**
   ```bash
   # データベースを確認
   # wp_postsテーブルが正常か確認
   ```

3. **最終手段: プラグインを一時的に無効化**
   ```
   WordPress管理画面 > プラグイン > Umaten トップページ > 無効化
   ↓
   投稿を編集・保存
   ↓
   v2.4.0をインストール
   ↓
   プラグインを有効化
   ```

### デバッグモードで確認

v2.4.0はデバッグログに対応しています。

```php
// wp-config.phpに追記
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
define('WP_DEBUG_DISPLAY', false);

// ログの場所
/path/to/wp-content/debug.log
```

ログには以下のような情報が記録されます：
```
Umaten Toppage v2.4.0: Setting up single post query for post ID 3799
Umaten Toppage v2.4.0: Loading single template - /path/to/single.php
```

## 使用方法

### URL構造

- **投稿ページ**: `/hokkaido/curry-ya-jack-hakodate-nakajima/`
  → v2.4.0で正常に投稿として表示 ✅
  → サイドバー、パンくずリスト、記事本文すべて正しく表示
  → 管理画面での編集も正常 ✅

- **カテゴリページ**: `/hokkaido/hakodate/`
  → 函館のすべての投稿を表示

- **タグ絞り込み**: `/hokkaido/hakodate/ramen/`
  → 函館のラーメン投稿を表示（ramenがタグの場合）

## 技術詳細

### is_admin()チェック

```php
public function handle_404_redirect() {
    // 【v2.4.0 重要】管理画面では一切処理しない
    if (is_admin()) {
        return;
    }

    // ... フロントエンドのみの処理
}
```

この単純なチェックが、管理画面での投稿更新を守ります。

### 安全なグローバル$post設定

```php
// v2.3.0（危険）
global $post;
$post = get_post($args['p']);
setup_postdata($post);

// v2.4.0（安全）
if ($wp_query->have_posts()) {
    $wp_query->the_post();  // WordPressの標準的な方法
}
```

`the_post()`を使用することで、WordPressのループシステムを正しく利用できます。

## パフォーマンス

- 管理画面では一切処理しないため、管理画面のパフォーマンスに影響なし
- フロントエンドでのクエリは最小限
- デバッグログは`WP_DEBUG`有効時のみ

## 互換性

- WordPress 5.0以上
- PHP 7.0以上
- Kusanagi環境で動作確認済み
- SWELL テーマで動作確認済み

## 変更履歴

### v2.4.0 (2025-11-14) - 緊急修正
- **重大な不具合修正**: 管理画面での投稿更新エラーを修正
- `is_admin()`チェックを追加
- グローバル$postの設定を`the_post()`で行うように変更
- `$wp_the_query`の同期を追加
- デバッグログ機能を追加
- フロントエンドの表示機能は維持

### v2.3.0 (2025-11-14) - 不具合あり（使用非推奨）
- 投稿積極表示機能を実装
- **問題**: 管理画面での投稿更新ができなくなる不具合

### v2.2.0 (2025-11-14)
- 投稿存在チェック機能を追加

### v2.1.0 (2025-11-14)
- URLリライトロジックを完全再設計

## ライセンス

GPL v2 or later

## 作者

Umaten
https://umaten.jp
